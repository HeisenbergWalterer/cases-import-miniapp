<!--case-entry.wxml-->
<view class="container">
  <!-- 进度条 -->
  <view class="progress-section">
    <view class="progress-header">
      <view class="progress-title">病例录入</view>
      <view class="progress-desc">第{{currentStep}}步，共6步</view>
    </view>
    <view class="progress">
      <view class="progress-bar" style="width: {{(currentStep/6*100)}}%"></view>
    </view>
    <view class="step-indicators">
      <view class="step-indicator {{index < currentStep ? 'completed' : index === currentStep - 1 ? 'active' : ''}}" 
            wx:for="{{steps}}" wx:key="index">
        <view class="step-number">{{index + 1}}</view>
        <view class="step-label">{{item}}</view>
      </view>
    </view>
  </view>

  <!-- 表单内容区域 -->
  <view class="form-section">
    <!-- 第1步：基本信息 -->
    <view class="step-content" wx:if="{{currentStep === 1}}">
      <view class="section-title">基本信息</view>
      
      <view class="form-group">
        <view class="form-label">性别 <text class="required">*</text></view>
        <view class="radio-group">
          <view class="radio-item {{formData.basicInfo.gender === '男' ? 'checked' : ''}}" 
                bindtap="onGenderChange" data-value="男">
            <view class="radio-icon">{{formData.basicInfo.gender === '男' ? '●' : '○'}}</view>
            <view class="radio-label">男</view>
          </view>
          <view class="radio-item {{formData.basicInfo.gender === '女' ? 'checked' : ''}}" 
                bindtap="onGenderChange" data-value="女">
            <view class="radio-icon">{{formData.basicInfo.gender === '女' ? '●' : '○'}}</view>
            <view class="radio-label">女</view>
          </view>
        </view>
        <view class="error-message" wx:if="{{errors.gender}}">{{errors.gender}}</view>
      </view>

      <view class="form-group">
        <view class="form-label">年龄 <text class="required">*</text></view>
        <input class="form-control {{errors.age ? 'error' : ''}}" 
               type="number" 
               placeholder="请输入年龄" 
               value="{{formData.basicInfo.age}}"
               bindinput="onAgeInput"
               maxlength="3" />
        <view class="form-hint">请输入0-120之间的年龄</view>
        <view class="error-message" wx:if="{{errors.age}}">{{errors.age}}</view>
      </view>
    </view>

    <!-- 第2步：症状信息 -->
    <view class="step-content" wx:if="{{currentStep === 2}}">
      <view class="section-title">症状信息</view>
      
      <view class="form-group">
        <view class="form-label">发现胆囊结石/息肉/腹痛等症状出现时间 <text class="required">*</text></view>
        <view class="duration-input">
          <input class="form-control duration-number {{errors.duration ? 'error' : ''}}" 
                 type="number" 
                 placeholder="时间" 
                 value="{{formData.symptoms.duration}}"
                 bindinput="onDurationInput" />
          <picker class="duration-unit" 
                  range="{{durationUnits}}" 
                  value="{{durationUnitIndex}}"
                  bindchange="onDurationUnitChange">
            <view class="picker-display {{!formData.symptoms.durationUnit ? 'placeholder' : ''}}">
              {{formData.symptoms.durationUnit || '单位'}}
            </view>
          </picker>
        </view>
        <view class="form-hint">请选择症状出现的时间长度</view>
        <view class="error-message" wx:if="{{errors.duration || errors.durationUnit}}">
          {{errors.duration || errors.durationUnit}}
        </view>
      </view>
    </view>

    <!-- 第3步：合并疾病 -->
    <view class="step-content" wx:if="{{currentStep === 3}}">
      <view class="section-title">合并疾病</view>
      <view class="form-hint mb-24">请选择患者现有的合并疾病（可多选）</view>
      
      <view class="checkbox-grid">
        <view class="checkbox-item {{item.checked ? 'checked' : ''}}" 
              wx:for="{{comorbidityOptions}}" wx:key="value"
              bindtap="onComorbidityChange" data-value="{{item.value}}">
          <view class="checkbox-icon">{{item.checked ? '☑' : '☐'}}</view>
          <view class="checkbox-label">{{item.label}}</view>
        </view>
      </view>
    </view>

    <!-- 第4步：既往病史 -->
    <view class="step-content" wx:if="{{currentStep === 4}}">
      <view class="section-title">既往曾有的胆囊相关疾病、并发症史</view>
      <view class="form-hint mb-24">请选择患者既往相关病史（可多选）</view>
      
      <view class="checkbox-grid">
        <view class="checkbox-item {{item.checked ? 'checked' : ''}}" 
              wx:for="{{pastHistoryOptions}}" wx:key="value"
              bindtap="onPastHistoryChange" data-value="{{item.value}}">
          <view class="checkbox-icon">{{item.checked ? '☑' : '☐'}}</view>
          <view class="checkbox-label">{{item.label}}</view>
        </view>
      </view>
    </view>

    <!-- 第5步：影像学报告 -->
    <view class="step-content" wx:if="{{currentStep === 5}}">
      <view class="section-title">影像学报告（B超）</view>
      
      <view class="form-group">
        <view class="form-label">上传报告文件</view>
        <view class="file-upload-area" bindtap="chooseImagingFile">
          <view class="upload-icon">📁</view>
          <view class="upload-text">点击上传影像学报告</view>
          <view class="upload-hint">支持图片和PDF文件，最大10MB</view>
        </view>
        <view class="file-list" wx:if="{{formData.imagingReport.files.length > 0}}">
          <view class="file-item" wx:for="{{formData.imagingReport.files}}" wx:key="index">
            <view class="file-info">
              <view class="file-name">{{item.name}}</view>
              <view class="file-size">{{item.sizeText}}</view>
            </view>
            <view class="file-actions">
              <text class="file-remove" bindtap="removeImagingFile" data-index="{{index}}">删除</text>
            </view>
          </view>
        </view>
      </view>

      <view class="form-group">
        <view class="form-label">详细报告</view>
        <textarea class="form-control textarea" 
                  placeholder="请输入B超检查的详细报告内容..."
                  value="{{formData.imagingReport.detailReport}}"
                  bindinput="onDetailReportInput"
                  maxlength="1000" />
        <view class="char-count">{{formData.imagingReport.detailReport.length}}/1000</view>
      </view>

      <view class="form-group">
        <view class="form-label">检查结论</view>
        <textarea class="form-control textarea" 
                  placeholder="请输入检查结论..."
                  value="{{formData.imagingReport.conclusion}}"
                  bindinput="onConclusionInput"
                  maxlength="500" />
        <view class="char-count">{{formData.imagingReport.conclusion.length}}/500</view>
      </view>
    </view>

    <!-- 第6步：病理报告 -->
    <view class="step-content" wx:if="{{currentStep === 6}}">
      <view class="section-title">病理报告</view>
      
      <view class="form-group">
        <view class="form-label">上传病理报告文件</view>
        <view class="file-upload-area" bindtap="choosePathologyFile">
          <view class="upload-icon">📁</view>
          <view class="upload-text">点击上传病理报告</view>
          <view class="upload-hint">支持图片和PDF文件，最大10MB</view>
        </view>
        <view class="file-list" wx:if="{{formData.pathologyReport.files.length > 0}}">
          <view class="file-item" wx:for="{{formData.pathologyReport.files}}" wx:key="index">
            <view class="file-info">
              <view class="file-name">{{item.name}}</view>
              <view class="file-size">{{item.sizeText}}</view>
            </view>
            <view class="file-actions">
              <text class="file-remove" bindtap="removePathologyFile" data-index="{{index}}">删除</text>
            </view>
          </view>
        </view>
      </view>

      <view class="form-group">
        <view class="form-label">病理诊断报告</view>
        <textarea class="form-control textarea" 
                  placeholder="请输入病理诊断报告内容..."
                  value="{{formData.pathologyReport.diagnosis}}"
                  bindinput="onDiagnosisInput"
                  maxlength="1000" />
        <view class="char-count">{{formData.pathologyReport.diagnosis.length}}/1000</view>
      </view>
    </view>
  </view>

  <!-- 底部操作栏 -->
  <view class="footer-actions safe-area">
    <button class="btn btn-secondary" wx:if="{{currentStep > 1}}" bindtap="prevStep">上一步</button>
    <button class="btn btn-primary" bindtap="saveDraft">保存草稿</button>
    <button class="btn btn-primary" wx:if="{{currentStep < 6}}" bindtap="nextStep">下一步</button>
    <button class="btn btn-success" wx:if="{{currentStep === 6}}" bindtap="submitForm">提交病例</button>
  </view>
</view>
